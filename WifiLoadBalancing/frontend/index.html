<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>WiFi Load Balancing — Live Visualization</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            background: #0b0b0b;
            color: white;
            margin: 0;
            overflow: hidden;
        }

        svg {
            background: #121212;
            display: block;
        }

        .room-rect {
            stroke: #333;
            fill: #101010;
            rx: 8;
            ry: 8;
        }

        .user {
            fill: cyan;
            transition: 0.25s;
        }
        .user:hover {
            r: 7 !important;
        }

        .ap-glow {
            filter: drop-shadow(0 0 8px #ff3b3b);
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.7);
            padding: 8px 10px;
            border: 1px solid #333;
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            font-size: 12px;
        }

        .user-line {
            pointer-events: none;
        }
    </style>
</head>

<body class="select-none">

<!-- Header -->
<header class="w-full text-center py-4 bg-gray-900 shadow-lg text-xl font-semibold tracking-wide">
    WiFi Load Balancing — Live Multi-Floor Visualization
</header>

<!-- Canvas -->
<div id="canvas" class="w-full h-[calc(100vh-64px)] overflow-auto flex justify-center">
    <!-- svg will be injected here -->
</div>
<div id="tooltip" class="tooltip"></div>

<!-- Left Dashboard -->
<div id="sidebar" class="fixed left-4 top-24 bg-white/10 backdrop-blur-xl border border-white/20 shadow-xl rounded-xl p-4 w-64 text-sm hidden"></div>

<!-- Legend -->
<div class="fixed right-4 top-24 bg-white/10 backdrop-blur-xl border border-white/20 text-sm shadow-xl rounded-xl p-4">
    <b class="text-lg">Legend</b><br><br>
    <div class="flex items-center gap-2 mb-1">
        <span class="w-3 h-3 rounded-full bg-green-400"></span>
        <span>AP: Low load (0–40%)</span>
    </div>
    <div class="flex items-center gap-2 mb-1">
        <span class="w-3 h-3 rounded-full bg-yellow-400"></span>
        <span>AP: Medium load (40–70%)</span>
    </div>
    <div class="flex items-center gap-2 mb-3">
        <span class="w-3 h-3 rounded-full bg-red-500"></span>
        <span>AP: High load (70–100%)</span>
    </div>
    <div class="flex items-center gap-2 mt-1">
        <span class="w-3 h-3 rounded-full bg-cyan-300"></span>
        <span>Users</span>
    </div>
    <p class="mt-3 text-gray-300 text-xs">AP circle size also scales with load.</p>
</div>

<!-- Zoom Controls -->
<div class="fixed bottom-6 right-6 flex gap-3">
    <button onclick="zoomIn()" class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg hover:bg-white/20">+</button>
    <button onclick="zoomOut()" class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg hover:bg-white/20">−</button>
</div>

<script>
let LAYOUT = null;
let svg, svgGroup, tooltip;
let zoom;

async function loadLayout() {
    LAYOUT = await fetch('./data/campus_layout.json').then(r => r.json());
}

function initSVG() {
    const { width, floorHeight, margin } = LAYOUT.canvas;
    const totalHeight = LAYOUT.floors.length * (floorHeight + margin) + margin;

    svg = d3.select("#canvas")
        .append("svg")
        .attr("viewBox", `0 0 ${width + 40} ${totalHeight}`)
        .attr("preserveAspectRatio", "xMidYMin meet")
        .classed("w-full", true)
        .classed("max-w-[1200px]", true);

    svgGroup = svg.append("g");
    tooltip = d3.select("#tooltip");

    zoom = d3.zoom()
        .scaleExtent([0.4, 3])
        .on("zoom", (event) => svgGroup.attr("transform", event.transform));

    svg.call(zoom);
}

function drawStaticLayout() {
    const floors = [...LAYOUT.floors].sort((a, b) => b.level - a.level);
    const { margin, floorHeight, width } = LAYOUT.canvas;

    floors.forEach((floor, idx) => {
        const top = margin + idx * (floorHeight + margin);

        svgGroup.append("rect")
            .attr("class", "floor-box")
            .attr("x", margin)
            .attr("y", top)
            .attr("width", width - margin * 2)
            .attr("height", floorHeight)
            .attr("fill", "#0f0f0f")
            .attr("stroke", "#222");

        svgGroup.append("text")
            .attr("x", margin + 12)
            .attr("y", top + 20)
            .attr("fill", "white")
            .attr("font-size", 14)
            .text(`Level ${floor.level} — ${floor.name}`);

        floor.rooms?.forEach(room => {
            const x = room.x + margin;
            const y = top + room.y;

            svgGroup.append("rect")
                .attr("class", "room-rect")
                .attr("x", x)
                .attr("y", y)
                .attr("width", room.width)
                .attr("height", room.height)
                .attr("opacity", 0.55);

            svgGroup.append("text")
                .attr("x", x + 8)
                .attr("y", y + 16)
                .attr("fill", "#ddd")
                .attr("font-size", 12)
                .text(room.name);
        });
    });
}

function toGlobal(floorLevel, room, lx, ly) {
    const floors = [...LAYOUT.floors].sort((a, b) => b.level - a.level);
    const index = floors.findIndex(f => f.level === floorLevel);

    const top = LAYOUT.canvas.margin + index * (LAYOUT.canvas.floorHeight + LAYOUT.canvas.margin);
    return { x: room.x + LAYOUT.canvas.margin + lx, y: top + room.y + ly };
}

function redrawState(state) {
    const aps = state.aps;
    const users = state.clients;

    // ---- Sidebar (floor stats) ----
    const sidebar = document.getElementById("sidebar");
    sidebar.innerHTML = "";
    sidebar.classList.remove("hidden");

    const floors = [...LAYOUT.floors].sort((a, b) => b.level - a.level);
    floors.forEach(floor => {
        const count = users.filter(u => u.floor === floor.level).length;
        sidebar.innerHTML += `
            <div class="mb-3 p-2 bg-white/5 rounded-lg border border-white/10 shadow">
                <b>Level ${floor.level}</b><br>
                ${floor.name}<br>
                Users: <span class="text-cyan-300">${count}</span>
            </div>
        `;
    });

    // Clear dynamic layers
    svgGroup.selectAll(".ap-node").remove();
    svgGroup.selectAll(".user-node").remove();
    svgGroup.selectAll(".user-line").remove();

    // ---- APs ----
    const apGroup = svgGroup.selectAll(".ap-node")
        .data(aps)
        .enter()
        .append("g")
        .attr("class", "ap-node")
        .each(function(d) {
            const floor = LAYOUT.floors.find(f => f.level === d.floor);
            if (!floor) return;
            const room = floor.rooms.find(r => r.name.toLowerCase() === d.room.toLowerCase());
            if (!room) return;
            const pos = toGlobal(d.floor, room, room.width / 2, room.height / 2);
            d._gx = pos.x;
            d._gy = pos.y;
        })
        .attr("transform", d => `translate(${d._gx},${d._gy})`);

    apGroup.append("circle")
        .attr("r", d => 10 + (d.load / 100) * 20)
        .attr("fill", d => d3.interpolateRdYlGn(1 - d.load / 100))
        .attr("class", d => d.load > 80 ? "ap-glow" : "")
        .on("mouseover", (event, d) => {
            tooltip
                .style("opacity", 1)
                .html(
                    `<b>${d.id}</b><br>
                    Floor: ${d.floor}<br>
                    Room: ${d.room}<br>
                    Load: ${d.load}%<br>
                    Clients: ${d.client_count}`
                )
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 20 + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

    apGroup.append("text")
        .attr("y", -25)
        .attr("text-anchor", "middle")
        .attr("fill", "white")
        .text(d => d.id);

    // ---- Users ----
    const userCircles = svgGroup.selectAll(".user-node")
        .data(users)
        .enter()
        .append("circle")
        .attr("class", "user user-node")
        .attr("r", 4)
        .each(function(d) {
            const floor = LAYOUT.floors.find(f => f.level === d.floor);
            if (!floor) return;
            const room = floor.rooms.find(r => r.name.toLowerCase() === d.room.toLowerCase());
            if (!room) return;
            const pos = toGlobal(d.floor, room, d.x % room.width, d.y % room.height);
            d._gx = pos.x;
            d._gy = pos.y;
        })
        // set initial position to avoid (0,0) jump
        .attr("cx", d => d._gx)
        .attr("cy", d => d._gy)
        .on("mouseover", (event, d) => {
            tooltip
                .style("opacity", 1)
                .html(
                    `<b>${d.id}</b><br>
                    Floor: ${d.floor}<br>
                    Room: ${d.room}<br>
                    AP: ${d.connected_ap || "—"}<br>
                    RSSI: ${d.RSSI}`
                )
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 20 + "px");
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

    // ---- User ↔ AP Lines ----
    svgGroup.selectAll(".user-line")
        .data(users.filter(u => u.connected_ap))
        .enter()
        .append("line")
        .attr("class", "user-line")
        .attr("stroke", "#666")
        .attr("stroke-width", 1)
        .attr("opacity", 0.35)
        .attr("x1", d => d._gx)
        .attr("y1", d => d._gy)
        .attr("x2", d => {
            const ap = aps.find(a => a.id === d.connected_ap);
            return ap ? ap._gx : d._gx;
        })
        .attr("y2", d => {
            const ap = aps.find(a => a.id === d.connected_ap);
            return ap ? ap._gy : d._gy;
        });
}

function startWebSocket() {
    const socket = new WebSocket("ws://127.0.0.1:8000/ws");

    socket.onmessage = (event) => redrawState(JSON.parse(event.data));
    socket.onclose = () => setTimeout(startWebSocket, 1500);
}

function zoomIn() {
    svg.transition().call(zoom.scaleBy, 1.2);
}

function zoomOut() {
    svg.transition().call(zoom.scaleBy, 0.8);
}

(async function main() {
    await loadLayout();
    initSVG();
    drawStaticLayout();
    startWebSocket();
})();
</script>

</body>
</html>
